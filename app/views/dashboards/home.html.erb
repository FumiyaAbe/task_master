<div class="mx-auto max-w-5xl px-4 py-6">
  <!-- ヘッダー -->
  <div class="page-head mb-4">
    <h1 class="text-2xl font-bold">カレンダー</h1>

    <div class="flex flex-wrap items-center gap-3">
      <% prev   = (@date - 1.month).strftime("%Y-%m") %>
      <% next_m = (@date + 1.month).strftime("%Y-%m") %>

      <!-- 月移動：現在のトグル値を引き継ぐ -->
      <%= link_to "〈 前の月",
            dashboard_path(month: prev,  show_events: (@show_events ? "1" : "0"), show_tasks: (@show_tasks ? "1" : "0")),
            class: "btn-ghost" %>
      <%= link_to "次の月 〉",
            dashboard_path(month: next_m, show_events: (@show_events ? "1" : "0"), show_tasks: (@show_tasks ? "1" : "0")),
            class: "btn-ghost" %>

      <!-- 表示/非表示トグル（チェック変更で即送信：ブラウザ標準） -->
      <%= form_with url: dashboard_path, method: :get, class: "flex items-center gap-2", local: true do %>
        <%= hidden_field_tag :month, @date.strftime("%Y-%m") %>

        <!-- 重要：未チェック時にも "0" を送る hidden をチェックボックスより前に置く -->
        <%= hidden_field_tag :show_events, "0" %>
        <label class="inline-flex items-center gap-1 text-sm">
          <%= check_box_tag :show_events, "1", @show_events,
                class: "rounded",
                onchange: "this.form.submit()" %>
          Events
        </label>

        <%= hidden_field_tag :show_tasks, "0" %>
        <label class="inline-flex items-center gap-1 text-sm">
          <%= check_box_tag :show_tasks, "1", @show_tasks,
                class: "rounded",
                onchange: "this.form.submit()" %>
          Tasks
        </label>
      <% end %>
    </div>
  </div>

  <!-- 曜日 -->
  <div class="calendar-week grid grid-cols-7 gap-2 text-sm mb-2">
    <% %w[日 月 火 水 木 金 土].each_with_index do |w, i| %>
      <% color = i == 0 ? 'text-red-600' : (i == 6 ? 'text-blue-600' : 'text-gray-600') %>
      <div class="text-center font-semibold <%= color %>"><%= w %></div>
    <% end %>
  </div>

  <!-- 7×6 グリッド -->
  <div class="calendar-grid grid grid-cols-7 gap-2 auto-rows-[minmax(120px,auto)]">
    <% @calendar_days.each do |week| %>
      <% week.each do |day| %>
        <% is_current_month = (day.month == @date.month) %>
        <% is_today = (day == Date.current) %>
        <% wday = day.wday %>
        <% day_color =
             if wday == 0
               'text-red-600'
             elsif wday == 6
               'text-blue-600'
             else
               is_current_month ? 'text-gray-700' : 'text-gray-400'
             end %>

        <div class="h-full rounded-xl border p-2 <%= is_current_month ? 'bg-white' : 'bg-gray-50' %> <%= 'tm-today' if is_today %>">
          <div class="mb-2 flex items-center justify-between">
            <span class="text-xs <%= day_color %>"><%= day.day %></span>
            <% if is_today %><span class="badge-red">今日</span><% end %>
          </div>

          <div class="space-y-1">
            <% Array(@events_by_day[day]).each do |ev| %>
              <%= link_to event_path(ev),
                          title: ev.title,
                          class: "grid grid-cols-[auto_auto_1fr] items-center gap-1 truncate rounded text-xs leading-tight hover:underline focus:outline-none focus-visible:ring-2" do %>
                <!-- 時刻（共通デザイン） -->
                <span class="tm-time"><%= ev.starts_at&.strftime("%H:%M") || "—" %></span>
                <!-- 種別 -->
                <span class="shrink-0 rounded bg-indigo-50 px-1 text-[10px] text-indigo-700">Event</span>
                <!-- 題名 -->
                <span class="ml-1 truncate break-words"><%= ev.title %></span>
              <% end %>
            <% end %>

            <% Array(@tasks_by_day[day]).each do |task| %>
              <%= link_to task_path(task),
                          title: task.title,
                          class: "grid grid-cols-[auto_auto_1fr] items-center gap-1 truncate rounded text-xs leading-tight hover:underline focus:outline-none focus-visible:ring-2" do %>
                <!-- 時刻（共通デザイン。due_atが無ければダッシュ） -->
                <span class="tm-time--task">
                  <%= task.respond_to?(:due_at) && task.due_at.present? ? task.due_at.strftime("%H:%M") : "—" %>
                </span>
                <!-- 種別 -->
                <span class="shrink-0 rounded bg-emerald-50 px-1 text-[10px] text-emerald-700">Task</span>
                <!-- 題名 -->
                <span class="ml-1 truncate break-words"><%= task.title %></span>
              <% end %>
            <% end %>
          </div>

        </div>
      <% end %>
    <% end %>
  </div>
</div>
